<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creatorflow - Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        ugc: {
                            bg: { DEFAULT: '#ffffff', dark: '#141414' },
                            sidebar: { DEFAULT: '#ffffff', dark: '#0F0F0F' },
                            card: { DEFAULT: '#ffffff', dark: '#1E1E1E' },
                            pink: '#E65696',
                            purple: '#9D66E3',
                            text: { DEFAULT: '#000000', dark: '#EAEAEA' },
                            muted: { DEFAULT: '#9ca3af', dark: '#A0A0A0' },
                            border: { DEFAULT: '#e5e7eb', dark: '#2A2A2A' },
                            hover: { DEFAULT: '#f3f4f6', dark: '#252525' }
                        }
                    },
                    transitionProperty: {
                        'width': 'width'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: var(--tw-bg-ugc-bg); color: var(--tw-text-ugc-text); }
        
        .text-gradient {
            background: linear-gradient(90deg, #E65696 0%, #9D66E3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--tw-bg-ugc-bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        body, html {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        :not(.dark) body {
            filter: brightness(1.05);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(230, 86, 150, 0.15) 0%, rgba(157, 102, 227, 0.05) 100%);
            border-left: 3px solid #E65696;
            color: #E65696;
        }

        /* Sidebar Collapsed Styles */
        .sidebar-collapsed .sidebar-text { display: none; opacity: 0; }
        .sidebar-collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
        .sidebar-collapsed .nav-item i { margin-right: 0; }
        .sidebar-collapsed .logo-text { display: none; }
        .sidebar-collapsed .section-label { display: none; }
        .sidebar-collapsed .user-info { display: none; }
        .sidebar-collapsed .nav-badge { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; padding: 0; border-radius: 50%; text-indent: -9999px; background-color: #E65696; }

        /* Animações */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sidebar mobile transition */
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.open { transform: translateX(0); }
    </style>
</head>
<body class="text-ugc-text flex h-screen overflow-hidden text-sm relative">

    <!-- Overlay para Mobile -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass" onclick="toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-ugc-sidebar border-r border-ugc-border flex flex-col sidebar-mobile md:translate-x-0 md:static transition-all duration-300 ease-in-out group/sidebar">
        <!-- Logo Area & Toggle -->
        <div class="h-20 flex items-center justify-between px-6 border-b border-ugc-border/50 relative">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-ugc-pink to-ugc-purple flex items-center justify-center shrink-0 shadow-lg shadow-ugc-pink/20">
                    <i data-lucide="sparkles" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-display font-bold text-lg tracking-wide ml-3 logo-text whitespace-nowrap overflow-hidden transition-all duration-300">Creatorflow</span>
            </div>
            
            <button onclick="toggleSidebarDesktop()" class="hidden md:flex absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-ugc-card border border-ugc-border rounded-full items-center justify-center text-ugc-muted hover:text-white hover:border-ugc-pink transition-colors z-50">
                <i id="sidebar-toggle-icon" data-lucide="chevron-left" class="w-3 h-3 transition-transform duration-300"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto overflow-x-hidden">
            <p class="section-label px-3 text-[10px] font-bold text-ugc-muted uppercase tracking-wider mb-2 mt-2 truncate">Principal</p>
            
            <a href="creatorflow.html" class="nav-item active w-full flex items-center px-3 py-2.5 rounded-lg text-ugc-text hover:bg-ugc-hover transition-colors group relative" title="Dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 group-hover:text-ugc-pink transition-colors shrink-0"></i>
                <span class="font-medium sidebar-text whitespace-nowrap overflow-hidden transition-all">Dashboard</span>
            </a>
            
            <a href="planner.html" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-ugc-muted hover:text-ugc-text hover:bg-ugc-hover transition-colors group relative" title="Planner">
                <i data-lucide="calendar" class="w-5 h-5 mr-3 group-hover:text-ugc-pink transition-colors shrink-0"></i>
                <span class="font-medium sidebar-text whitespace-nowrap overflow-hidden transition-all">Planner</span>
            </a>

            <a href="tasks.html" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-ugc-muted hover:text-ugc-text hover:bg-ugc-hover transition-colors group relative" title="Tasks">
                <i data-lucide="briefcase" class="w-5 h-5 mr-3 group-hover:text-ugc-pink transition-colors shrink-0"></i>
                <span class="font-medium sidebar-text whitespace-nowrap overflow-hidden transition-all">Tasks</span>
            </a>

            <p class="section-label px-3 text-[10px] font-bold text-ugc-muted uppercase tracking-wider mb-2 mt-6 truncate">Criação</p>

            <a href="scripts.html" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-ugc-muted hover:text-ugc-text hover:bg-ugc-hover transition-colors group relative" title="Roteiros IA">
                <i data-lucide="file-text" class="w-5 h-5 mr-3 group-hover:text-ugc-pink transition-colors shrink-0"></i>
                <span class="font-medium sidebar-text whitespace-nowrap overflow-hidden transition-all">Roteiros IA</span>
                <span class="nav-badge ml-auto bg-ugc-pink/20 text-ugc-pink text-[10px] px-2 py-0.5 rounded-full font-bold sidebar-text">NOVO</span>
            </a>

            <button onclick="alert('Funcionalidade em desenvolvimento')" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-ugc-muted hover:text-ugc-text hover:bg-ugc-hover transition-colors group relative" data-view="prospeccao" title="Prospecção">
                <i data-lucide="send" class="w-5 h-5 mr-3 group-hover:text-ugc-pink transition-colors shrink-0"></i>
                <span class="font-medium sidebar-text whitespace-nowrap overflow-hidden transition-all">Prospecção</span>
            </button>

            <p class="section-label px-3 text-[10px] font-bold text-ugc-muted uppercase tracking-wider mb-2 mt-6 truncate">Gestão</p>

            <button onclick="alert('Funcionalidade em desenvolvimento')" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-ugc-muted hover:text-ugc-text hover:bg-ugc-hover transition-colors group relative" data-view="financeiro" title="Financeiro">
                <i data-lucide="dollar-sign" class="w-5 h-5 mr-3 group-hover:text-ugc-pink transition-colors shrink-0"></i>
                <span class="font-medium sidebar-text whitespace-nowrap overflow-hidden transition-all">Financeiro</span>
            </button>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-ugc-border">
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-ugc-hover cursor-pointer transition-colors" title="Perfil">
                <img id="profile-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="Perfil" class="w-9 h-9 rounded-full border border-ugc-border shrink-0">
                <div class="flex-1 min-w-0 user-info transition-opacity duration-300">
                    <p id="profile-name" class="text-sm font-medium text-white truncate"></p>
                    <p id="profile-email" class="text-xs text-ugc-muted truncate"></p>
                </div>
                <i data-lucide="settings" class="w-4 h-4 text-ugc-muted user-info"></i>
                <button onclick="logout()" title="Sair" class="ml-2 p-1 rounded hover:bg-ugc-hover">
                    <i data-lucide="log-out" class="w-4 h-4 text-ugc-muted"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-ugc-bg overflow-y-auto relative transition-all duration-300">
        <!-- Header Mobile -->
        <div class="md:hidden h-16 bg-ugc-card border-b border-ugc-border flex items-center justify-between px-4 sticky top-0 z-20">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-ugc-pink to-ugc-purple flex items-center justify-center">
                    <i data-lucide="sparkles" class="text-white w-4 h-4"></i>
                </div>
                <span class="font-bold text-white">Creatorflow</span>
            </div>
            <button onclick="toggleMobileMenu()" class="p-2 text-ugc-muted hover:text-white"><i data-lucide="menu" class="w-6 h-6"></i></button>
        </div>

        <div class="p-6 md:p-10 max-w-7xl mx-auto w-full min-h-screen">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section animate-fade-in">
                <!-- Header Section -->
                <header class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-display font-bold text-white mb-2">
                            Boa noite, <span class="text-gradient">criadora!</span> ✨
                        </h1>
                        <p id="header-subtitle" class="text-ugc-muted">Carregando dados...</p>
                    </div>
                    <button onclick="openModal()" class="bg-white text-black hover:bg-gray-100 px-5 py-2.5 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-lg shadow-white/5 active:scale-95">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Novo Task
                    </button>
                </header>

                <!-- Priority Card (Dynamic) -->
                <div id="priority-card" class="bg-gradient-to-r from-ugc-card to-[#25202b] rounded-2xl p-6 border border-ugc-border mb-10 relative overflow-hidden group min-h-[160px] flex items-center justify-center">
                    <p class="text-ugc-muted animate-pulse">Buscando prioridades...</p>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="bg-ugc-card p-5 rounded-xl border border-ugc-border hover:border-ugc-border/80 transition-all">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400"><i data-lucide="video" class="w-5 h-5"></i></div>
                            <span class="text-xs text-ugc-muted bg-ugc-bg px-2 py-1 rounded">Total</span>
                        </div>
                        <p id="stat-pending" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-ugc-muted mt-1">UGCs Pendentes</p>
                    </div>

                    <div class="bg-ugc-card p-5 rounded-xl border border-ugc-border hover:border-ugc-border/80 transition-all">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-green-500/10 rounded-lg text-green-400"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                            <span class="text-xs text-ugc-muted bg-ugc-bg px-2 py-1 rounded">Total</span>
                        </div>
                        <p id="stat-delivered" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-ugc-muted mt-1">UGCs Entregues</p>
                    </div>

                    <div class="bg-ugc-card p-5 rounded-xl border border-ugc-border hover:border-ugc-border/80 transition-all">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-yellow-500/10 rounded-lg text-yellow-400"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                        </div>
                        <p id="stat-value" class="text-2xl font-bold text-white">R$ 0,00</p>
                        <p class="text-xs text-ugc-muted mt-1">Receita Prevista</p>
                    </div>

                    <div class="bg-ugc-card p-5 rounded-xl border border-ugc-border hover:border-ugc-border/80 transition-all">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400"><i data-lucide="clock" class="w-5 h-5"></i></div>
                        </div>
                        <p id="stat-deadline" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-ugc-muted mt-1">Próximos Prazos</p>
                    </div>
                </div>

                <!-- Bottom Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-lg text-white">Últimos Tasks</h3>
                        </div>

                        <div id="recent-tasks-list" class="space-y-3">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="font-bold text-lg text-white">Dicas Rápidas</h3>
                        <a href="scripts.html" class="block bg-gradient-to-br from-purple-900/40 to-ugc-card p-5 rounded-xl border border-purple-500/20 relative overflow-hidden group hover:border-purple-500/40 transition-all cursor-pointer">
                            <div class="flex items-start gap-3 relative z-10">
                                <div class="p-2 bg-white/10 rounded-lg">
                                    <i data-lucide="sparkles" class="w-4 h-4 text-purple-300"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-white text-sm mb-1">Roteiros com IA</h4>
                                    <p class="text-xs text-ugc-muted leading-relaxed">Use a IA para criar roteiros criativos em segundos! Clique para testar.</p>
                                </div>
                            </div>
                        </a>
                        <div class="bg-ugc-card p-5 rounded-xl border border-ugc-border group hover:border-ugc-pink/30 transition-all cursor-pointer">
                            <div class="flex items-start gap-3">
                                <div class="p-2 bg-ugc-bg rounded-lg text-green-400">
                                    <i data-lucide="pie-chart" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-white text-sm mb-1">Organize suas finanças</h4>
                                    <p class="text-xs text-ugc-muted leading-relaxed">Acompanhe pagamentos e receitas mensais.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Restaura perfil a partir do localStorage (mantém fixo entre páginas)
        (function restoreProfileFromStorage(){
            try {
                const name = localStorage.getItem('cf_profile_name');
                const email = localStorage.getItem('cf_profile_email');
                const avatar = localStorage.getItem('cf_profile_avatar');
                if (name && document.getElementById('profile-name')) document.getElementById('profile-name').innerText = name;
                if (email && document.getElementById('profile-email')) document.getElementById('profile-email').innerText = email;
                if (avatar && document.getElementById('profile-avatar')) document.getElementById('profile-avatar').src = avatar;
            } catch(e) { /* ignore */ }
        })();
    </script>

    <!-- Modal Novo Task -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div id="modal-content" class="bg-ugc-card w-full max-w-md mx-4 rounded-2xl border border-ugc-border shadow-2xl transform scale-95 transition-transform duration-300 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Novo Task</h3>
                <button onclick="closeModal()" class="text-ugc-muted hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="new-task-form" onsubmit="handleNewTask(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-ugc-muted mb-1.5">Marca / Cliente</label>
                    <input type="text" id="task-brand" required placeholder="Ex: La Roche Posay" class="w-full bg-ugc-bg border border-ugc-border rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-ugc-pink focus:ring-1 focus:ring-ugc-pink transition-all">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-ugc-muted mb-1.5">Tipo</label>
                        <select id="task-type" class="w-full bg-ugc-bg border border-ugc-border rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-ugc-pink transition-all">
                            <option value="Reels">Reels</option>
                            <option value="TikTok">TikTok</option>
                            <option value="Stories">Stories</option>
                            <option value="Combo">Combo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-ugc-muted mb-1.5">Valor (R$)</label>
                        <input type="number" id="task-value" required placeholder="0,00" class="w-full bg-ugc-bg border border-ugc-border rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-ugc-pink transition-all">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-ugc-muted mb-1.5">Prazo de Entrega</label>
                    <input type="date" id="task-date" required class="w-full bg-ugc-bg border border-ugc-border rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-ugc-pink transition-all [color-scheme:dark]">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-transparent border border-ugc-border text-white py-2.5 rounded-lg hover:bg-ugc-hover transition-colors">Cancelar</button>
                    <button type="submit" class="flex-1 bg-ugc-pink hover:bg-pink-600 text-white font-bold py-2.5 rounded-lg shadow-lg shadow-ugc-pink/20 transition-all transform active:scale-95">Salvar Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURAÇÃO DO FIREBASE (Sua Configuração) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAP4fQ3TZ09XWggKNKZJDMJQ8TnRdNYwzc",
          authDomain: "ugcp-9ec19.firebaseapp.com",
          projectId: "ugcp-9ec19",
          storageBucket: "ugcp-9ec19.firebasestorage.app",
          messagingSenderId: "921864203168",
          appId: "1:921864203168:web:55fb378c2a904737d512c5",
          measurementId: "G-51WXW579CN"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'creatorflow-app'; 
        let userId = null;
        let isSidebarCollapsed = false;

        // Protege a página: exige usuário autenticado via email/senha (não anônimo)
        onAuthStateChanged(auth, (user) => {
                if (user) {
                if (user.isAnonymous) {
                    // força sign-out de visitantes anônimos
                    signOut(auth).then(() => { window.location.href = './index.html'; }).catch(()=>{ window.location.href = './index.html'; });
                } else {
                    userId = user.uid;
                    setupRealtimeListener();
                    // Atualiza sidebar com nome/email e persiste para manter em outras páginas
                    const pn = document.getElementById('profile-name');
                    const pe = document.getElementById('profile-email');
                    const pa = document.getElementById('profile-avatar');
                    const displayName = user.displayName || (user.email ? user.email.split('@')[0] : '');
                    if (pn) pn.innerText = displayName;
                    if (pe) pe.innerText = user.email || '';
                    if (pa) pa.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.replace(/\s+/g,'+'))}&background=E65696&color=fff`;
                    try {
                        localStorage.setItem('cf_profile_name', displayName);
                        localStorage.setItem('cf_profile_email', user.email || '');
                        localStorage.setItem('cf_profile_avatar', pa ? pa.src : '');
                    } catch (e) { /* ignore */ }
                }
            } else {
                window.location.href = './index.html';
            }
        });

        // Logout helper
        window.logout = async () => {
            try { await signOut(auth); window.location.href = './index.html'; }
            catch (e) { console.error('Logout erro', e); }
        }

        function setupRealtimeListener() {
            if (!userId) return;
            const tasksCollection = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            
            onSnapshot(tasksCollection, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => tasks.push({ id: doc.id, ...doc.data() }));
                
                // Ordenar localmente
                tasks.sort((a, b) => {
                    const dateA = a.createdAt?.seconds || 0;
                    const dateB = b.createdAt?.seconds || 0;
                    return dateB - dateA;
                });
                
                updateDashboard(tasks);
            });
        }

        function updateDashboard(tasks) {
            // Cálculos
            const pending = tasks.filter(j => j.status !== 'done');
            const delivered = tasks.filter(j => j.status === 'done');
            const revenue = tasks.reduce((sum, j) => sum + (Number(j.value) || 0), 0);
            
            // Atualiza Elementos
            const statPending = document.getElementById('stat-pending');
            const statDelivered = document.getElementById('stat-delivered');
            const statValue = document.getElementById('stat-value');
            const statDeadlines = document.getElementById('stat-deadline');
            
            if(statPending) statPending.innerText = pending.length;
            if(statDelivered) statDelivered.innerText = delivered.length;
            if(statValue) statValue.innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(revenue);
            if(statDeadlines) statDeadlines.innerText = pending.length; 

            const headerSubtitle = document.getElementById('header-subtitle');
            if(headerSubtitle) {
                headerSubtitle.innerText = pending.length > 0 ? 
                `Você tem ${pending.length} entrega(s) pendente(s).` : "Tudo em dia! Sem pendências.";
            }

            // Card de Prioridade
            const priorityCard = document.getElementById('priority-card');
            if (priorityCard) {
                if (pending.length > 0) {
                    const urgent = [...pending].sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                    const dateObj = new Date(urgent.date);
                    const dateStr = dateObj.toLocaleDateString('pt-BR', {timeZone: 'UTC', day: '2-digit', month: 'short'});
                    
                    priorityCard.innerHTML = `
                        <div class="absolute top-0 right-0 w-64 h-64 bg-ugc-pink/5 rounded-full blur-3xl -mr-10 -mt-10 transition-all group-hover:bg-ugc-pink/10"></div>
                        <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 w-full">
                            <div>
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="w-2 h-2 rounded-full bg-ugc-pink animate-pulse"></span>
                                    <span class="text-ugc-pink text-xs font-bold uppercase tracking-wider">Sua Prioridade Agora</span>
                                </div>
                                <h2 class="text-2xl font-bold text-white mb-1">${urgent.brand}</h2>
                                <p class="text-ugc-muted text-sm flex items-center gap-2">
                                    <i data-lucide="video" class="w-3 h-3"></i> ${urgent.type} • R$ ${urgent.value}
                                </p>
                            </div>
                            <div class="flex items-center gap-6 bg-ugc-bg/50 p-4 rounded-xl border border-white/5 backdrop-blur-sm">
                                <div class="text-center px-2"><p class="text-xs text-ugc-muted mb-1">Prazo</p><p class="font-bold text-white text-lg">${dateStr}</p></div>
                                <div class="h-8 w-px bg-white/10"></div>
                                <a href="tasks.html" class="bg-ugc-pink hover:bg-pink-600 text-white px-4 py-2 rounded-lg font-medium text-xs transition-colors shadow-lg flex items-center justify-center">Ver no Quadro</a>
                            </div>
                        </div>`;
                } else {
                    priorityCard.innerHTML = `
                        <div class="text-center z-10">
                            <h2 class="text-xl font-bold text-white mb-1">Sem tasks ativos</h2>
                            <p class="text-ugc-muted text-sm">Aproveite para prospectar novas marcas.</p>
                        </div>`;
                }
            }

            // Lista Recente
            const list = document.getElementById('recent-tasks-list');
            if (list) {
                if (tasks.length === 0) {
                    list.innerHTML = `<p class="text-ugc-muted text-sm italic">Nenhuma task adicionada ainda.</p>`;
                } else {
                    list.innerHTML = tasks.slice(0, 3).map(job => `
                        <div class="bg-ugc-card p-4 rounded-xl border border-ugc-border flex items-center justify-between group hover:border-ugc-pink/30 transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-[#1a1a1a] border border-white/5 flex items-center justify-center text-xs font-bold text-white">${job.brand.substring(0,2).toUpperCase()}</div>
                                <div><h4 class="font-bold text-white group-hover:text-ugc-pink transition-colors">${job.brand}</h4><p class="text-xs text-ugc-muted">${job.type}</p></div>
                            </div>
                            <span class="bg-gray-500/10 text-gray-400 text-xs px-2 py-1 rounded border border-gray-500/20">${job.status === 'done' ? 'Entregue' : 'Pendente'}</span>
                        </div>
                    `).join('');
                }
            }
            lucide.createIcons();
        }

        // --- GLOBAL WRAPPERS (Para HTML acessar) ---
        window.handleNewTask = async function(e) {
            e.preventDefault();
            if (!userId) return;
            const brand = document.getElementById('task-brand').value;
            const type = document.getElementById('task-type').value;
            const value = document.getElementById('task-value').value;
            const date = document.getElementById('task-date').value;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'tasks'), {
                    brand, type, value, date, status: 'todo', createdAt: new Date()
                });
                closeModal();
                showToast('Novo Task salvo!');
            } catch (error) { console.error(error); showToast("Erro ao salvar."); }
        }

        window.toggleSidebarDesktop = () => {
            const s=document.getElementById('sidebar'), i=document.getElementById('sidebar-toggle-icon'); isSidebarCollapsed=!isSidebarCollapsed; 
            if(isSidebarCollapsed){s.classList.add('w-20','sidebar-collapsed');s.classList.remove('w-64');i.style.transform='rotate(180deg)'}
            else{s.classList.remove('w-20','sidebar-collapsed');s.classList.add('w-64');i.style.transform='rotate(0deg)'}
        }
        window.toggleMobileMenu = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }
        window.showToast = (m) => { 
            const c=document.getElementById('toast-container'), t=document.createElement('div'); 
            t.className='toast bg-ugc-card border border-ugc-pink/30 text-white px-4 py-3 rounded-lg shadow-xl flex gap-3 min-w-[300px] pointer-events-auto'; 
            t.innerHTML=`<div class="bg-ugc-pink/20 p-1.5 rounded-full text-ugc-pink"><i data-lucide="check" class="w-4 h-4"></i></div><span class="text-sm font-medium">${m}</span>`; 
            c.appendChild(t); lucide.createIcons(); 
            setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(20px)';setTimeout(()=>t.remove(),300)},3000); 
        }
        window.openModal = () => {
            const o=document.getElementById('modal-overlay'), c=document.getElementById('modal-content'); o.classList.remove('hidden'); 
            setTimeout(()=>{o.classList.remove('opacity-0');c.classList.remove('scale-95');c.classList.add('scale-100');},10);
            document.getElementById('task-date').value = new Date().toLocaleDateString('en-CA');
        }
        window.closeModal = () => { 
            const o=document.getElementById('modal-overlay'), c=document.getElementById('modal-content'); 
            o.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('scale-95'); 
            setTimeout(()=>{o.classList.add('hidden');document.getElementById('new-task-form').reset();},300); 
        }

        // Theme toggle
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateThemeIcon();
        };

        // Update theme icon
        function updateThemeIcon() {
            const themeIcon = document.querySelector('#theme-toggle-icon');
            if (themeIcon) {
                themeIcon.setAttribute('data-lucide', document.documentElement.classList.contains('dark') ? 'sun' : 'moon');
                lucide.createIcons();
            }
        }

        // Load theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
        updateThemeIcon();

        // onAuthStateChanged cuida do fluxo de inicialização
        lucide.createIcons();
    </script>
</body>
</html>